name: E2E Tests

on:
  push:
    branches:
      - master
      - 'claude/**'
    paths:
      - 'tauri-app/**'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches:
      - master
    paths:
      - 'tauri-app/**'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch: # Allow manual triggering

env:
  RUST_BACKTRACE: 1

jobs:
  # ===== LINUX E2E TESTS =====
  e2e-linux:
    name: E2E Tests (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            webkit2gtk-driver \
            xvfb \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: tauri-app/src-tauri

      - name: Cache Tauri debug build
        id: cache-tauri-build
        uses: actions/cache@v4
        with:
          path: tauri-app/src-tauri/target/debug
          key: tauri-debug-${{ runner.os }}-${{ hashFiles('tauri-app/src/**', 'tauri-app/src-tauri/**', 'tauri-app/pnpm-lock.yaml') }}
          restore-keys: |
            tauri-debug-${{ runner.os }}-

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Node dependencies
        working-directory: tauri-app
        run: bun install

      - name: Install cargo-binstall
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

      - name: Install tauri-driver
        run: cargo binstall tauri-driver --no-confirm

      - name: Verify tauri-driver installation
        run: |
          which tauri-driver
          tauri-driver -h || echo "‚úÖ tauri-driver is installed"

      - name: Generate TanStack Router routes
        working-directory: tauri-app
        timeout-minutes: 2
        run: |
          # Start Vite dev server to trigger TanStack Router plugin (generates routeTree.gen)
          bun run dev &
          DEV_PID=$!

          # Wait for route tree generation (max 30 seconds)
          for i in {1..30}; do
            if [ -f "src/routeTree.gen.ts" ]; then
              echo "‚úÖ Route tree generated!"
              break
            fi
            sleep 1
          done

          # Kill dev server
          kill $DEV_PID 2>/dev/null || true

          # Verify file exists
          if [ ! -f "src/routeTree.gen.ts" ]; then
            echo "‚ùå Failed to generate route tree"
            exit 1
          fi

      - name: Build Tauri app (debug mode)
        if: steps.cache-tauri-build.outputs.cache-hit != 'true'
        working-directory: tauri-app
        run: bun run tauri:build:debug
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Check cached build
        if: steps.cache-tauri-build.outputs.cache-hit == 'true'
        run: echo "‚úÖ Using cached Tauri debug build"

      - name: Verify binary exists
        working-directory: tauri-app
        run: |
          ls -la src-tauri/target/debug/
          test -f src-tauri/target/debug/tauri-app || exit 1
          chmod +x src-tauri/target/debug/tauri-app
          echo "‚úÖ Binary found and made executable!"

      - name: Run E2E tests (with Xvfb)
        working-directory: tauri-app
        run: |
          # Run tests with xvfb-run (official Tauri recommendation)
          echo "Starting E2E tests..."
          set +e  # Don't exit on error
          xvfb-run bun run test:e2e 2>&1 | tee ../e2e-test-output.log
          TEST_EXIT_CODE=$?
          set -e

          echo ""
          echo "=========================================="
          echo "Test execution completed with exit code: $TEST_EXIT_CODE"
          echo "=========================================="

          # Show last 100 lines of output for quick diagnosis
          echo ""
          echo "Last 100 lines of test output:"
          tail -n 100 ../e2e-test-output.log || true

          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs-linux
          path: |
            e2e-test-output.log
            tauri-app/e2e/screenshots/
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots-linux-failure
          path: tauri-app/e2e/screenshots/
          retention-days: 30

      - name: Check test results
        if: always()
        run: |
          if [ -f e2e-test-output.log ]; then
            echo "üìä Test Results Summary:"
            echo "===================="
            cat e2e-test-output.log | grep -E "(passed|failed|total)" || echo "No summary found"
            echo ""

            # Check if tests passed
            if grep -q "failed" e2e-test-output.log; then
              echo "‚ùå Some tests failed. Check logs for details."
              exit 1
            else
              echo "‚úÖ All tests passed!"
            fi
          else
            echo "‚ö†Ô∏è No test output log found"
            exit 1
          fi

  # ===== WINDOWS E2E TESTS =====
  e2e-windows:
    name: E2E Tests (Windows)
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: tauri-app/src-tauri

      - name: Cache Tauri debug build
        id: cache-tauri-build
        uses: actions/cache@v4
        with:
          path: tauri-app/src-tauri/target/debug
          key: tauri-debug-${{ runner.os }}-${{ hashFiles('tauri-app/src/**', 'tauri-app/src-tauri/**', 'tauri-app/pnpm-lock.yaml') }}
          restore-keys: |
            tauri-debug-${{ runner.os }}-

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Node dependencies
        working-directory: tauri-app
        run: bun install

      - name: Install cargo-binstall
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/cargo-bins/cargo-binstall/releases/latest/download/cargo-binstall-x86_64-pc-windows-msvc.zip" -OutFile cargo-binstall.zip
          Expand-Archive cargo-binstall.zip -DestinationPath . -Force
          Move-Item -Path cargo-binstall.exe -Destination "$env:USERPROFILE\.cargo\bin\" -Force

      - name: Install tauri-driver
        run: cargo binstall tauri-driver --no-confirm

      - name: Verify tauri-driver installation
        shell: pwsh
        run: |
          where.exe tauri-driver
          tauri-driver -h
          Write-Host "‚úÖ tauri-driver is installed"

      - name: Generate TanStack Router routes
        working-directory: tauri-app
        timeout-minutes: 2
        shell: pwsh
        run: |
          # Start Vite dev server to trigger TanStack Router plugin (generates routeTree.gen)
          $process = Start-Process -FilePath "bun" -ArgumentList "run", "dev" -PassThru -NoNewWindow

          # Wait for route tree generation (max 30 seconds)
          $maxAttempts = 30
          for ($i = 1; $i -le $maxAttempts; $i++) {
            if (Test-Path "src/routeTree.gen.ts") {
              Write-Host "‚úÖ Route tree generated!"
              break
            }
            Start-Sleep -Seconds 1
          }

          # Kill dev server
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue

          # Verify file exists
          if (-not (Test-Path "src/routeTree.gen.ts")) {
            Write-Host "‚ùå Failed to generate route tree"
            exit 1
          }

      - name: Build Tauri app (debug mode)
        if: steps.cache-tauri-build.outputs.cache-hit != 'true'
        working-directory: tauri-app
        run: bun run tauri:build:debug
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Check cached build
        if: steps.cache-tauri-build.outputs.cache-hit == 'true'
        shell: pwsh
        run: Write-Host "‚úÖ Using cached Tauri debug build"

      - name: Verify binary exists
        working-directory: tauri-app
        shell: pwsh
        run: |
          Get-ChildItem src-tauri/target/debug/
          if (!(Test-Path src-tauri/target/debug/tauri-app.exe)) { exit 1 }
          Write-Host "‚úÖ Binary found!"

      - name: Run E2E tests
        working-directory: tauri-app
        shell: pwsh
        run: |
          # Run tests with detailed logging
          Write-Host "Starting E2E tests..."
          $ErrorActionPreference = 'Continue'
          bun run test:e2e 2>&1 | Tee-Object -FilePath ../e2e-test-output.log
          $TEST_EXIT_CODE = $LASTEXITCODE

          Write-Host ""
          Write-Host "=========================================="
          Write-Host "Test execution completed with exit code: $TEST_EXIT_CODE"
          Write-Host "=========================================="

          # Show last 100 lines of output for quick diagnosis
          Write-Host ""
          Write-Host "Last 100 lines of test output:"
          if (Test-Path ../e2e-test-output.log) {
            Get-Content ../e2e-test-output.log -Tail 100
          }

          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs-windows
          path: |
            e2e-test-output.log
            tauri-app/e2e/screenshots/
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots-windows-failure
          path: tauri-app/e2e/screenshots/
          retention-days: 30

      - name: Check test results
        if: always()
        shell: pwsh
        run: |
          if (Test-Path e2e-test-output.log) {
            Write-Host "üìä Test Results Summary:"
            Write-Host "===================="
            Get-Content e2e-test-output.log | Select-String -Pattern "(passed|failed|total)" | ForEach-Object { Write-Host $_ }
            Write-Host ""

            # Check if tests passed
            if (Select-String -Path e2e-test-output.log -Pattern "failed" -Quiet) {
              Write-Host "‚ùå Some tests failed. Check logs for details."
              exit 1
            } else {
              Write-Host "‚úÖ All tests passed!"
            }
          } else {
            Write-Host "‚ö†Ô∏è No test output log found"
            exit 1
          }

  # ===== SUMMARY JOB =====
  test-summary:
    name: Test Summary
    needs: [e2e-linux, e2e-windows]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check overall status
        run: |
          LINUX_STATUS="${{ needs.e2e-linux.result }}"
          WINDOWS_STATUS="${{ needs.e2e-windows.result }}"

          echo "Linux tests: $LINUX_STATUS"
          echo "Windows tests: $WINDOWS_STATUS"
          echo ""

          if [ "$LINUX_STATUS" == "success" ] && [ "$WINDOWS_STATUS" == "success" ]; then
            echo "‚úÖ All E2E tests passed across all platforms!"
            exit 0
          else
            echo "‚ùå Some E2E tests failed. Check individual job logs."
            exit 1
          fi
