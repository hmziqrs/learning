name: E2E Tests

on:
  push:
    branches:
      - master
      - 'claude/**'
    paths:
      - 'tauri-app/**'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches:
      - master
    paths:
      - 'tauri-app/**'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch: # Allow manual triggering

env:
  RUST_BACKTRACE: 1

jobs:
  e2e-tests:
    name: E2E Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false # Run all tests even if one fails
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===== LINUX SETUP =====
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            webkit2gtk-driver \
            xvfb \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      # ===== WINDOWS SETUP =====
      # Note: Windows doesn't need additional setup for tauri-driver
      # tauri-driver handles WebDriver protocol directly

      # ===== RUST SETUP =====
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: tauri-app/src-tauri

      # ===== NODE/BUN SETUP =====
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # ===== INSTALL DEPENDENCIES =====
      - name: Install Node dependencies
        working-directory: tauri-app
        run: bun install --frozen-lockfile

      # ===== INSTALL TAURI-DRIVER =====
      - name: Install tauri-driver
        run: cargo install tauri-driver
        env:
          CARGO_INCREMENTAL: 0

      - name: Verify tauri-driver installation (Linux)
        if: runner.os == 'Linux'
        run: |
          which tauri-driver
          tauri-driver -h || echo "‚úÖ tauri-driver is installed"

      - name: Verify tauri-driver installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          where.exe tauri-driver
          tauri-driver -h
          Write-Host "‚úÖ tauri-driver is installed"

      # ===== GENERATE TANSTACK ROUTER ROUTES =====
      - name: Generate TanStack Router routes (Linux)
        if: runner.os == 'Linux'
        working-directory: tauri-app
        timeout-minutes: 2
        run: |
          # Start Vite dev server to trigger TanStack Router plugin (generates routeTree.gen)
          bun run dev &
          DEV_PID=$!

          # Wait for route tree generation (max 30 seconds)
          for i in {1..30}; do
            if [ -f "src/routeTree.gen.ts" ]; then
              echo "‚úÖ Route tree generated!"
              break
            fi
            sleep 1
          done

          # Kill dev server
          kill $DEV_PID 2>/dev/null || true

          # Verify file exists
          if [ ! -f "src/routeTree.gen.ts" ]; then
            echo "‚ùå Failed to generate route tree"
            exit 1
          fi

      - name: Generate TanStack Router routes (Windows)
        if: runner.os == 'Windows'
        working-directory: tauri-app
        timeout-minutes: 2
        shell: pwsh
        run: |
          # Start Vite dev server to trigger TanStack Router plugin (generates routeTree.gen)
          $process = Start-Process -FilePath "bun" -ArgumentList "run", "dev" -PassThru -NoNewWindow

          # Wait for route tree generation (max 30 seconds)
          $maxAttempts = 30
          for ($i = 1; $i -le $maxAttempts; $i++) {
            if (Test-Path "src/routeTree.gen.ts") {
              Write-Host "‚úÖ Route tree generated!"
              break
            }
            Start-Sleep -Seconds 1
          }

          # Kill dev server
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue

          # Verify file exists
          if (-not (Test-Path "src/routeTree.gen.ts")) {
            Write-Host "‚ùå Failed to generate route tree"
            exit 1
          }

      # ===== BUILD TAURI APP =====
      - name: Build Tauri app (debug mode)
        working-directory: tauri-app
        run: bun run tauri:build:debug
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      # ===== VERIFY BUILD =====
      - name: Verify binary exists (Linux)
        if: runner.os == 'Linux'
        working-directory: tauri-app
        run: |
          ls -la src-tauri/target/debug/
          test -f src-tauri/target/debug/tauri-app || exit 1
          chmod +x src-tauri/target/debug/tauri-app
          echo "‚úÖ Binary found and made executable!"

      - name: Verify binary exists (Windows)
        if: runner.os == 'Windows'
        working-directory: tauri-app
        shell: pwsh
        run: |
          Get-ChildItem src-tauri/target/debug/
          if (!(Test-Path src-tauri/target/debug/tauri-app.exe)) { exit 1 }
          Write-Host "‚úÖ Binary found!"

      # ===== RUN E2E TESTS =====
      - name: Run E2E tests (Linux with Xvfb)
        if: runner.os == 'Linux'
        working-directory: tauri-app
        run: |
          # Start Xvfb (fake display for headless testing)
          export DISPLAY=:99
          Xvfb :99 -screen 0 1280x720x24 &
          sleep 2

          # Run tests with detailed logging
          bun run test:e2e 2>&1 | tee ../e2e-test-output.log
        continue-on-error: true

      - name: Run E2E tests (Windows)
        if: runner.os == 'Windows'
        working-directory: tauri-app
        shell: pwsh
        run: |
          # Run tests with detailed logging
          bun run test:e2e 2>&1 | Tee-Object -FilePath ../e2e-test-output.log
        continue-on-error: true

      # ===== SAVE ARTIFACTS =====
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs-${{ matrix.os }}
          path: |
            e2e-test-output.log
            tauri-app/e2e/screenshots/
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots-${{ matrix.os }}-failure
          path: tauri-app/e2e/screenshots/
          retention-days: 30

      # ===== CHECK TEST RESULTS =====
      - name: Check test results
        if: always()
        shell: bash
        run: |
          if [ -f e2e-test-output.log ]; then
            echo "üìä Test Results Summary:"
            echo "===================="
            cat e2e-test-output.log | grep -E "(passed|failed|total)" || echo "No summary found"
            echo ""

            # Check if tests passed
            if grep -q "failed" e2e-test-output.log; then
              echo "‚ùå Some tests failed. Check logs for details."
              exit 1
            else
              echo "‚úÖ All tests passed!"
            fi
          else
            echo "‚ö†Ô∏è No test output log found"
            exit 1
          fi

  # ===== SUMMARY JOB =====
  test-summary:
    name: Test Summary
    needs: e2e-tests
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check overall status
        run: |
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "‚úÖ All E2E tests passed across all platforms!"
            exit 0
          else
            echo "‚ùå Some E2E tests failed. Check individual job logs."
            exit 1
          fi
